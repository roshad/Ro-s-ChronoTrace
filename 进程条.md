# 进程条方案

## 功能定义（已确认）
- 只记录前台**进程名**变化上下文，不记录窗口标题。
- 按秒采样前台进程（1 秒 1 条）。
- hover 统计显示 Top 3 进程。
- hover 区间规则：
  - 有行为条目：按该行为条目时间范围统计。
  - 无行为条目：按“连续同进程区间”统计。
- 点击状态条：
  - 仅当点击点处于空白区间时触发创建。
  - 弹窗让用户输入标签、类别等信息。
- 数据保留：
  - 仅保留最近 30 天。
  - 启动时清理一次，运行中每小时清理一次。

## 资源消耗估算（核心）

### 计算前提
- 采样频率：1 秒 1 条。
- 每条记录字段：`timestamp(i64) + process_name(text) + day_id(i32)`。
- 索引：`timestamp`、`day_id`、`process_name`（3 个）。
- SQLite + WAL 模式。
- 单行综合开销（含索引与页开销）按区间估算：**110B ~ 280B / 行**。

### 行数规模
- 1 天：`86,400` 行
- 7 天：`604,800` 行
- 30 天：`2,592,000` 行
- 90 天：`7,776,000` 行
- 365 天：`31,536,000` 行

### 磁盘占用估算（数据文件主量级）
- 7 天：约 **63 MiB ~ 162 MiB**
- 30 天：约 **272 MiB ~ 692 MiB**
- 90 天：约 **816 MiB ~ 2.03 GiB**
- 365 天：约 **3.23 GiB ~ 8.22 GiB**

说明：
- WAL/碎片等运行时额外开销通常会再增加约 10%~30%。
- 在“只保留 30 天”策略下，稳态建议预留磁盘预算：**1.0 ~ 1.5 GiB**（含 WAL 余量）。

### 写入量（I/O）估算
- 固定插入：86,400 行/天。
- 纯数据体量（不含索引/WAL）：约 9~25 MB/天。
- 实际写入（含索引 + WAL + checkpoint）通常量级：约 **25~80 MB/天**。

### 运行时开销估算
- CPU：前台窗口查询 + 单条写库/秒，常见桌面环境约 **0.2% ~ 1.5%**。
- 内存：
  - 当天全量读取 86,400 条用于前端聚合时，
  - JSON 传输量约 **5~12 MB**，
  - 前端对象化后峰值内存通常在 **20~60 MB** 区间（与实现细节相关）。

## 风险与控制
- 风险：按秒写入导致库增长快。
- 控制：
  - 固定 30 天保留。
  - 启动 + 每小时自动清理。
  - 必要时加分页/按需查询，避免一次加载超大时间范围。

## 结论
- 该方案可实现接近 Toggl 的秒级体验。
- 在“30 天保留”约束下，资源消耗可控。
- 与分钟采样相比，空间与 I/O 显著上升，但统计精度和交互一致性明显提升。

## 测试与校验场景
1. 公式校验：确认 1 秒采样在 7/30/90/365 天的行数计算正确。  
2. 空间校验：按 `110B` 与 `280B` 两个边界重算，确认区间合理。  
3. 稳态校验：验证“30 天保留 + 每小时清理”后数据库体积趋于稳定。  
4. 运行校验：连续运行 24 小时后，检查写入量、CPU、内存是否落在文档估算区间。  

## 假设与默认值
- 默认按秒采样，不做自适应降频。
- 默认仅 process_name，不记录 window_title。
- 默认 3 个索引均开启。
- 默认 WAL 模式开启。
- 默认严格只保留 30 天，不做历史聚合归档。
