name: Release Windows EXE

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install frontend dependencies
        run: npm ci

      - name: Validate updater signing secrets
        shell: pwsh
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY) {
            throw "Missing TAURI_SIGNING_PRIVATE_KEY secret."
          }
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD) {
            throw "Missing TAURI_SIGNING_PRIVATE_KEY_PASSWORD secret."
          }

          $keyPath = Join-Path $env:RUNNER_TEMP "updater-private.key"
          $testPath = Join-Path $env:RUNNER_TEMP "updater-secret-check.txt"

          [System.IO.File]::WriteAllText($keyPath, $env:TAURI_SIGNING_PRIVATE_KEY)
          [System.IO.File]::WriteAllText($testPath, "updater secret check")

          npx tauri signer sign -f $keyPath -p "$env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" $testPath
          Write-Host "Updater signing secret check passed."

      - name: Build and publish EXE
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ env.RELEASE_TAG }}
          releaseName: Ro's ChronoTrace ${{ env.RELEASE_TAG }}
          releaseBody: Download the *.exe installer from the Assets section.
          releaseDraft: false
          prerelease: false
          args: --bundles nsis

      - name: Verify updater assets in release
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $headers = @{
            Authorization = "Bearer $env:GH_TOKEN"
            "User-Agent"  = "github-actions-updater-check"
            Accept        = "application/vnd.github+json"
          }
          $tag = "${{ env.RELEASE_TAG }}"
          $repo = "${{ github.repository }}"
          $uri = "https://api.github.com/repos/$repo/releases/tags/$tag"
          $hasLatestJson = $false
          $hasSig = $false
          $assetNames = @()

          for ($attempt = 1; $attempt -le 10; $attempt++) {
            try {
              $release = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get
              $assetNames = @($release.assets | ForEach-Object { $_.name })
              $hasLatestJson = $assetNames -contains "latest.json"
              $hasSig = $assetNames | Where-Object { $_ -match "\.sig$" } | Measure-Object | Select-Object -ExpandProperty Count

              if ($hasLatestJson -and ($hasSig -gt 0)) {
                Write-Host "Updater assets verified: $($assetNames -join ', ')"
                break
              }
            } catch {
              Write-Host "Attempt $attempt: failed to query release assets yet."
            }

            if ($attempt -lt 10) {
              Start-Sleep -Seconds 6
            }
          }

          if (-not $hasLatestJson) {
            throw "Release $tag is missing latest.json. Verify bundle.createUpdaterArtifacts=true and signing key secrets."
          }
          if (-not ($hasSig -gt 0)) {
            throw "Release $tag has no updater signature (*.sig) asset."
          }
